{% extends "base.html" %}

{% block content %}
<div class="container">    <div class="discover-header">
        <h2>ğŸ” å‘ç°æ–°æœ‹å‹</h2>
        <p class="discover-subtitle">åŸºäºå…±åŒå…´è¶£ä¸ºä½ æ¨èå¿—åŒé“åˆçš„ç”¨æˆ·</p>
        <button id="refresh-btn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ¨è</button>
    </div>

    {% if users %}
        <div class="user-cards">
            {% for user in users %}
            <div class="user-card" data-user-id="{{ user.id }}">
                <div class="user-card-header">
                    <img src="{{ user.avatar_url or '/static/default-avatar.svg' }}"
                         alt="å¤´åƒ" class="avatar-large">
                    <div class="user-info">
                        <h3><a href="{{ url_for('user.profile', user_id=user.id) }}">{{ user.username }}</a></h3>
                        {% if user.bio %}
                            <p class="user-bio">{{ user.bio }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="user-tags">
                    <span class="tags-label">å…±åŒå…´è¶£ï¼š</span>
                    {% for tag in user.tags %}
                        {% if tag in current_user.tags %}
                            <span class="tag tag-matched">{{ tag.name }}</span>
                        {% else %}
                            <span class="tag">{{ tag.name }}</span>
                        {% endif %}
                    {% endfor %}
                </div>                <div class="user-stats">
                    <span class="stat">åŠ¨æ€ {{ user.posts_count }}</span>
                    <span class="stat">å…³æ³¨ {{ user.followed_count }}</span>
                    <span class="stat">ç²‰ä¸ {{ user.followers_count }}</span>
                </div>

                <div class="user-actions">
                    <button class="follow-btn" data-user-id="{{ user.id }}">
                        {% if current_user.is_following(user) %}
                            å–æ¶ˆå…³æ³¨
                        {% else %}
                            å…³æ³¨
                        {% endif %}
                    </button>
                    <a href="{{ url_for('user.profile', user_id=user.id) }}" class="view-profile-btn">æŸ¥çœ‹èµ„æ–™</a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="discover-footer">
            <p class="text-muted">æ²¡æœ‰æ›´å¤šæ¨èäº†ï¼Ÿè¯•è¯•<a href="{{ url_for('user.edit_profile') }}">ç¼–è¾‘ä½ çš„æ ‡ç­¾</a>æ¥å‘ç°æ›´å¤šæœ‰è¶£çš„äººï¼</p>
        </div>
    {% else %}
        <div class="empty-discover">
            <div class="empty-icon">ğŸ¤</div>
            <h3>æš‚æ— æ¨èç”¨æˆ·</h3>
            <p>çœ‹èµ·æ¥æ²¡æœ‰å’Œä½ æœ‰å…±åŒå…´è¶£çš„ç”¨æˆ·ï¼Œæˆ–è€…ä»–ä»¬éƒ½å·²ç»è¢«ä½ å…³æ³¨äº†ï¼</p>
            <div class="empty-actions">
                <a href="{{ url_for('user.edit_profile') }}" class="btn btn-primary">æ·»åŠ æ›´å¤šæ ‡ç­¾</a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    {% endif %}
</div>

<!-- æ·»åŠ åˆ·æ–°æ¨èçš„JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-btn');
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            this.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
            this.disabled = true;
            
            try {
                const response = await fetch('/user/api/refresh_recommendations');
                if (response.ok) {
                    const data = await response.json();
                    renderUsers(data.users);
                    showMessage('æ¨èå·²åˆ·æ–°', 'success');
                } else {
                    showMessage('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆ·æ–°æ¨èå¤±è´¥:', error);
                showMessage('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                this.textContent = 'ğŸ”„ åˆ·æ–°æ¨è';
                this.disabled = false;
            }
        });
    }
    
    function renderUsers(users) {
        const container = document.querySelector('.container');
        
        if (users.length === 0) {
            // æ˜¾ç¤ºç©ºçŠ¶æ€
            container.innerHTML = `
                <div class="discover-header">
                    <h2>ğŸ” å‘ç°æ–°æœ‹å‹</h2>
                    <p class="discover-subtitle">åŸºäºå…±åŒå…´è¶£ä¸ºä½ æ¨èå¿—åŒé“åˆçš„ç”¨æˆ·</p>
                    <button id="refresh-btn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ¨è</button>
                </div>
                <div class="empty-discover">
                    <div class="empty-icon">ğŸ¤</div>
                    <h3>æš‚æ— æ¨èç”¨æˆ·</h3>
                    <p>çœ‹èµ·æ¥æ²¡æœ‰å’Œä½ æœ‰å…±åŒå…´è¶£çš„ç”¨æˆ·ï¼Œæˆ–è€…ä»–ä»¬éƒ½å·²ç»è¢«ä½ å…³æ³¨äº†ï¼</p>
                    <div class="empty-actions">
                        <a href="{{ url_for('user.edit_profile') }}" class="btn btn-primary">æ·»åŠ æ›´å¤šæ ‡ç­¾</a>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                    </div>
                </div>
            `;
        } else {
            // ç”Ÿæˆç”¨æˆ·å¡ç‰‡
            let userCardsHtml = '';
            users.forEach(user => {
                const tagsHtml = user.tags.map(tag => 
                    `<span class="tag ${tag.matched ? 'tag-matched' : ''}">${tag.name}</span>`
                ).join('');
                
                userCardsHtml += `
                    <div class="user-card" data-user-id="${user.id}">
                        <div class="user-card-header">
                            <img src="${user.avatar_url}" alt="å¤´åƒ" class="avatar-large">
                            <div class="user-info">
                                <h3><a href="/user/profile/${user.id}">${user.username}</a></h3>
                                ${user.bio ? `<p class="user-bio">${user.bio}</p>` : ''}
                            </div>
                        </div>
                        <div class="user-tags">
                            <span class="tags-label">å…±åŒå…´è¶£ï¼š</span>
                            ${tagsHtml}
                        </div>
                        <div class="user-stats">
                            <span class="stat">åŠ¨æ€ ${user.posts_count}</span>
                            <span class="stat">å…³æ³¨ ${user.followed_count}</span>
                            <span class="stat">ç²‰ä¸ ${user.followers_count}</span>
                        </div>
                        <div class="user-actions">
                            <button class="follow-btn" data-user-id="${user.id}">
                                ${user.is_following ? 'å–æ¶ˆå…³æ³¨' : 'å…³æ³¨'}
                            </button>
                            <a href="/user/profile/${user.id}" class="view-profile-btn">æŸ¥çœ‹èµ„æ–™</a>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="discover-header">
                    <h2>ğŸ” å‘ç°æ–°æœ‹å‹</h2>
                    <p class="discover-subtitle">åŸºäºå…±åŒå…´è¶£ä¸ºä½ æ¨èå¿—åŒé“åˆçš„ç”¨æˆ·</p>
                    <button id="refresh-btn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ¨è</button>
                </div>
                <div class="user-cards">
                    ${userCardsHtml}
                </div>
                <div class="discover-footer">
                    <p class="text-muted">æ²¡æœ‰æ›´å¤šæ¨èäº†ï¼Ÿè¯•è¯•<a href="{{ url_for('user.edit_profile') }}">ç¼–è¾‘ä½ çš„æ ‡ç­¾</a>æ¥å‘ç°æ›´å¤šæœ‰è¶£çš„äººï¼</p>
                </div>
            `;
        }
        
        // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        bindEventListeners();
    }
    
    function bindEventListeners() {
        // é‡æ–°ç»‘å®šåˆ·æ–°æŒ‰é’®
        const newRefreshBtn = document.getElementById('refresh-btn');
        if (newRefreshBtn && !newRefreshBtn.hasListener) {
            newRefreshBtn.hasListener = true;
            newRefreshBtn.addEventListener('click', async function() {
                this.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
                this.disabled = true;
                
                try {
                    const response = await fetch('/user/api/refresh_recommendations');
                    if (response.ok) {
                        const data = await response.json();
                        renderUsers(data.users);
                        showMessage('æ¨èå·²åˆ·æ–°', 'success');
                    } else {
                        showMessage('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°æ¨èå¤±è´¥:', error);
                    showMessage('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                } finally {
                    this.textContent = 'ğŸ”„ åˆ·æ–°æ¨è';
                    this.disabled = false;
                }
            });
        }
        
        // é‡æ–°ç»‘å®šå…³æ³¨æŒ‰é’®
        const followButtons = document.querySelectorAll('.follow-btn');
        followButtons.forEach(button => {
            if (!button.hasListener) {
                button.hasListener = true;
                button.addEventListener('click', async function() {
                    const userId = this.dataset.userId;
                    const isDiscoverPage = window.location.pathname.includes('/discover');
                    
                    try {
                        const response = await fetch(`/follow/follow/${userId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            
                            if (isDiscoverPage && data.action === 'followed') {
                                // å‘ç°é¡µé¢ï¼šå…³æ³¨åç§»é™¤ç”¨æˆ·å¡ç‰‡
                                const userCard = this.closest('.user-card');
                                userCard.style.opacity = '0.5';
                                userCard.style.transform = 'scale(0.95)';
                                
                                setTimeout(() => {
                                    userCard.remove();
                                    showMessage('å·²å…³æ³¨ï¼Œç”¨æˆ·å·²ä»æ¨èåˆ—è¡¨ä¸­ç§»é™¤', 'success');
                                    
                                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ¨èç”¨æˆ·
                                    const remainingCards = document.querySelectorAll('.user-card');
                                    if (remainingCards.length === 0) {
                                        // æ˜¾ç¤ºç©ºæ¨èçŠ¶æ€
                                        const container = document.querySelector('.container');
                                        container.innerHTML = `
                                            <div class="discover-header">
                                                <h2>ğŸ” å‘ç°æ–°æœ‹å‹</h2>
                                                <p class="discover-subtitle">åŸºäºå…±åŒå…´è¶£ä¸ºä½ æ¨èå¿—åŒé“åˆçš„ç”¨æˆ·</p>
                                                <button id="refresh-btn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ¨è</button>
                                            </div>
                                            <div class="empty-discover">
                                                <div class="empty-icon">ğŸ¤</div>
                                                <h3>æš‚æ— æ¨èç”¨æˆ·</h3>
                                                <p>çœ‹èµ·æ¥æ²¡æœ‰å’Œä½ æœ‰å…±åŒå…´è¶£çš„ç”¨æˆ·ï¼Œæˆ–è€…ä»–ä»¬éƒ½å·²ç»è¢«ä½ å…³æ³¨äº†ï¼</p>
                                                <div class="empty-actions">
                                                    <a href="/user/edit_profile" class="btn btn-primary">æ·»åŠ æ›´å¤šæ ‡ç­¾</a>
                                                    <a href="/" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                                                </div>
                                            </div>
                                        `;
                                        bindEventListeners();
                                    }
                                }, 300);
                            } else {
                                // å…¶ä»–é¡µé¢æˆ–å–æ¶ˆå…³æ³¨ï¼šæ›´æ–°æŒ‰é’®çŠ¶æ€
                                if (data.action === 'followed') {
                                    this.textContent = 'å–æ¶ˆå…³æ³¨';
                                    this.style.background = '#e74c3c';
                                    if (!isDiscoverPage) {
                                        showMessage('å…³æ³¨æˆåŠŸ', 'success');
                                    }
                                } else {
                                    this.textContent = 'å…³æ³¨';
                                    this.style.background = '#3498db';
                                    showMessage('å·²å–æ¶ˆå…³æ³¨', 'info');
                                }
                            }
                        }
                    } catch (error) {
                        console.error('å…³æ³¨æ“ä½œå¤±è´¥:', error);
                        showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    }
                });
            }
        });
    }
    
    // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showMessage(message, type = 'info') {
        // ç§»é™¤ç°æœ‰æ¶ˆæ¯
        const existingMessage = document.querySelector('.discover-flash-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `discover-flash-message`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        `;
        
        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        const colors = {
            success: '#27ae60',
            error: '#e74c3c',
            info: '#3498db',
            warning: '#f39c12'
        };
        messageDiv.style.backgroundColor = colors[type] || colors.info;
        
        document.body.appendChild(messageDiv);
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            messageDiv.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 300);
        }, 3000);
    }
});
</script>

<style>
.discover-header {
    text-align: center;
    margin-bottom: 30px;
}

.discover-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.discover-subtitle {
    color: #7f8c8d;
    font-size: 16px;
    margin-bottom: 15px;
}

.refresh-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.refresh-btn:active {
    transform: scale(0.95);
}

.refresh-btn.loading {
    background: #95a5a6;
    cursor: not-allowed;
    animation: rotate 1s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.user-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.user-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.user-card-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.user-card-header .avatar-large {
    margin-right: 15px;
    flex-shrink: 0;
}

.user-info {
    flex: 1;
}

.user-info h3 {
    margin: 0 0 8px 0;
}

.user-info h3 a {
    color: #2c3e50;
    text-decoration: none;
}

.user-info h3 a:hover {
    color: #3498db;
}

.user-bio {
    color: #7f8c8d;
    font-size: 14px;
    margin: 0;
    line-height: 1.4;
}

.user-tags {
    margin-bottom: 15px;
}

.tags-label {
    font-size: 12px;
    color: #95a5a6;
    display: block;
    margin-bottom: 5px;
}

.tag-matched {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    font-weight: 500;
}

.user-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    padding: 10px 0;
    border-top: 1px solid #ecf0f1;
}

.stat {
    font-size: 12px;
    color: #7f8c8d;
}

.user-actions {
    display: flex;
    gap: 10px;
}

.view-profile-btn {
    flex: 1;
    padding: 8px 16px;
    background: #ecf0f1;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 6px;
    text-align: center;
    transition: background 0.3s ease;
    font-size: 14px;
}

.view-profile-btn:hover {
    background: #d5dbdb;
    text-decoration: none;
    color: #2c3e50;
}

.follow-btn {
    flex: 1;
    padding: 8px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
    font-size: 14px;
}

.follow-btn:hover {
    background: #2980b9;
}

.empty-discover {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.empty-discover h3 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.empty-discover p {
    color: #7f8c8d;
    margin-bottom: 30px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.empty-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.discover-footer {
    text-align: center;
    padding: 20px;
    border-top: 1px solid #ecf0f1;
}

.discover-footer a {
    color: #3498db;
    text-decoration: none;
}

.discover-footer a:hover {
    text-decoration: underline;
}

/* åˆ·æ–°æŒ‰é’®æ ·å¼ */
.refresh-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 10px;
    transition: background 0.3s ease;
}

.refresh-btn:hover {
    background: #2980b9;
}

.refresh-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
}

/* æ¶ˆæ¯åŠ¨ç”» */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .user-cards {
        grid-template-columns: 1fr;
    }
    
    .user-card-header {
        flex-direction: column;
        text-align: center;
    }
    
    .user-card-header .avatar-large {
        margin: 0 auto 15px auto;
    }
    
    .empty-actions {
        flex-direction: column;
        align-items: center;    }
}
</style>

{% endblock %}